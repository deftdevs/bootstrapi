name: Release

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version (only if different from current SNAPSHOT version)'
        type: string
        required: false
      developmentVersion:
        description: 'Development version after release (only if different from auto-generated version)'
        type: string
        required: false

## Requires workflow permissions to be set to 'read and write permissions'
## in Repository -> Settings -> Action -> General (and organisation settings)
permissions:
  contents: write

jobs:
  release:

    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: 17
        distribution: temurin
        cache: 'maven'
        server-id: central
        server-username: MAVEN_CENTRAL_USERNAME
        server-password: MAVEN_CENTRAL_PASSWORD
        gpg-private-key: ${{ secrets.RELEASE_GPG_PRIVATE_KEY }}
        gpg-passphrase: RELEASE_GPG_PASSPHRASE

    - name: Configure Git user
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: Prepare and perform release (validate on Maven Central)
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        RELEASE_GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        RELEASE_VERSION: ${{ inputs.releaseVersion }}
        DEVELOPMENT_VERSION: ${{ inputs.developmentVersion }}
      run: |
        mvn -B -P release release:prepare release:perform \
          -DreleaseVersion="$RELEASE_VERSION" \
          -DdevelopmentVersion="$DEVELOPMENT_VERSION" \
          -Darguments="-DskipITs -Dcentral.autoPublish=false -Dcentral.waitUntil=validated" \
          | tee maven-output.log
        DEPLOYMENT_ID=$(grep -oP 'Deployment \K[a-f0-9-]+' maven-output.log | head -1)
        if [ -z "$DEPLOYMENT_ID" ]; then
          echo "::error::Could not extract deployment ID from Maven output"
          exit 1
        fi
        echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> "$GITHUB_ENV"
        echo "Deployment $DEPLOYMENT_ID validated successfully"

    - name: Push release commits and tag
      run: |
        git push origin "$(git describe --tags --abbrev=0)"
        git push

    - name: Publish release on Maven Central
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
      run: |
        AUTH_TOKEN=$(printf '%s' "$MAVEN_CENTRAL_USERNAME:$MAVEN_CENTRAL_PASSWORD" | base64)

        curl -f --retry 3 -X POST \
          "https://central.sonatype.com/api/v1/publisher/deployment/$DEPLOYMENT_ID" \
          -H "Authorization: Bearer $AUTH_TOKEN"

        echo "Waiting for publication to complete..."
        for i in $(seq 1 120); do
          sleep 10
          STATE=$(curl -s -X POST \
            "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID" \
            -H "Authorization: Bearer $AUTH_TOKEN" | jq -r '.deploymentState')
          echo "Deployment state: $STATE"
          if [ "$STATE" = "PUBLISHED" ]; then
            echo "Release published successfully on Maven Central"
            exit 0
          elif [ "$STATE" = "FAILED" ]; then
            echo "::error::Publication failed on Maven Central"
            exit 1
          fi
        done
        echo "::error::Timed out waiting for publication (20 minutes)"
        exit 1
